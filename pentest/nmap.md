

## Basics 

**Формат использования**:  
```bash
nmap [Типы сканирования] [Опции] {Цели}
```
###### Определение целей (Target Specification)
Nmap позволяет указывать цели различными способами:  
**Имена хостов**: `scanme.nmap.org`, `microsoft.com`  
**IP-адреса и диапазоны**: `192.168.0.1`, `10.0.0-255.1-254`  
**CIDR-диапазоны**: `192.168.1.0/24`  
###### Полезные опции:  
  ```bash
  nmap -iL targets.txt
  nmap -iR 100
  nmap 192.168.0.0/16 --exclude 192.168.1.1,192.168.1.100
  nmap -iL targets.txt --excludefile excluded.txt
  ```  
 `-iL <файл>`: Загрузка списка хостов или сетей из файла.  
 `-iR <кол-во>`: Сканирование случайных целей.  
 `--exclude <цели>`: Исключить указанные хосты или сети.  
 `--excludefile <файл>`: Исключить список хостов из файла.  

#### Обнаружение хостов (Host Discovery)
Эти опции полезны для быстрого определения доступных (живых) хостов.
 ```bash
nmap -sL 192.168.1.0/24
nmap -sn 192.168.0.0/16
nmap -Pn 192.168.1.1
nmap -PS 80,443 192.168.1.1
nmap -PU 123 192.168.1.0/24
nmap -PE 192.168.1.1
nmap -PO1,6,17 192.168.1.1
```
`-sL`: Выводит список целей, но не сканирует.  
 `-sn`: Выполняет только проверку на доступность (Ping Scan), без сканирования портов.  
 `-Pn`: Отключает проверку доступности (предполагает, что все хосты доступны).  
 `-PS/PA/PU/PY[порт]`: Использует TCP SYN/ACK, UDP или SCTP пакеты для обнаружения.  
 `-PE/PP/PM`: ICMP (ping) с использованием запросов Echo, Timestamp или Netmask.  
 `-PO[список протоколов]`: Ping с использованием указанных IP-протоколов.  
 
#### DNS-резолвинг и трассировка маршрута
```bash
nmap -n 192.168.1.0/24
nmap -R scanme.nmap.org
nmap --dns-servers 9.9.9.9 scanme.nmap.org
nmap --system-dns scanme.nmap.org
nmap --traceroute 192.168.1.1
```
 `-n`: Отключить резолвинг DNS (ускоряет сканирование).  
 `-R`: Всегда выполнять DNS-резолвинг.  
 `--dns-servers <серверы>`: Указать кастомные DNS-серверы.  
 `--system-dns`: Использовать системный DNS-резолвер.  
 `--traceroute`: Выполнить трассировку маршрута до каждой цели.  

##### Примеры 
1. **Сканирование всех активных хостов в локальной сети**:  
   ```bash
   nmap -sn 192.168.1.0/24
   ```
2. **Определение активных хостов с использованием ICMP Ping**:  
   ```bash
   nmap -PE 192.168.0.0/16
   ```
3. **Сканирование с исключением конкретных хостов**:  
   ```bash
   nmap -sn 192.168.0.0/16 --exclude 192.168.1.1,192.168.1.2
   ```
4. **Список всех целей без выполнения сканирования**:  
   ```bash
   nmap -sL 10.0.0.0/24
   ```
5. **Сканирование с использованием случайного выбора целей**:  
   ```bash
   nmap -iR 50 -Pn
   ```

#### Техники сканирования (Scan Techniques)
##### Основные техники TCP-сканирования:
```bash
nmap -sS 192.168.1.1
nmap -sT 192.168.1.1
nmap -sA 192.168.1.1
nmap -sW 192.168.1.1
nmap -sM 192.168.1.1
  ```
 `-sS`: **SYN-сканирование (полускан)**. Быстрое и скрытное сканирование, так как соединение не устанавливается полностью.  
 `-sT`: **Connect()-сканирование**. Использует стандартный вызов TCP connect(). Менее скрытно, так как записывается в логи.  
 `-sA`: **ACK-сканирование**. Проверка правил файервола и определения открытых портов.  
 `-sW`: **Window-сканирование**. Аналогично ACK-сканированию, но использует анализ TCP окон.  
 `-sM`: **Maimon-сканирование**. Использует нестандартные TCP-флаги для обхода некоторых файерволов.  
##### UDP-сканирование:
```bash
nmap -sU 192.168.1.1
```
 `-sU`: Сканирование UDP-портов. Используется для поиска служб на базе UDP (например, DNS или SNMP).  
##### **Silent TCP-сканы:**
```bash
nmap -sN 192.168.1.1
nmap -sF 192.168.1.1
nmap -sX 192.168.1.1
  ```
 `-sN`: **Null-сканирование**. Без активных флагов TCP. Полезно для обхода файерволов.  
 `-sF`: **FIN-сканирование**. Отправляет только FIN-флаги, чтобы обойти стандартные фильтры.  
 `-sX`: **Xmas-сканирование**. Включает FIN, PSH и URG флаги.  
###### Дополнительные техники сканирования:
```bash
nmap --scanflags SYN,ACK 192.168.1.1
nmap -sI 192.168.1.100 192.168.1.1
nmap -sO 192.168.1.1
nmap -b ftp.example.com 192.168.1.1
```
 `--scanflags <флаги>`: Пользовательская настройка флагов TCP.  
 `-sI <зомби-хост>`: **Idle-сканирование**. Использует "зомби-хост" для маскировки исходящего сканирования.  
 `-sO`: Сканирование IP-протоколов для определения поддерживаемых протоколов.  
 `-b <FTP-хост>`: FTP Bounce сканирование. Позволяет сканировать через промежуточный FTP-сервер.  

#### Работа с портами (Port Specification and Scan Order)
##### Указание портов:
```bash
nmap -p22 192.168.1.1       # Только порт 22
nmap -p1-65535 192.168.1.1 # Все порты
nmap -p U:53,T:22-25 192.168.1.1  # UDP 53, TCP 22-25

nmap -p1-65535 --exclude-ports 80,443 192.168.1.1
```
`-p <порты>`: Сканировать только указанные порты.  
`--exclude-ports <диапазоны>`: Исключить определённые порты из сканирования.  
##### Оптимизация скорости и порядка сканирования:
```bash
nmap -F 192.168.1.1
nmap -r 192.168.1.1
nmap --top-ports 100 192.168.1.1
nmap --port-ratio 0.1 192.168.1.1
```
 `-F`: Быстрое сканирование. Охватывает меньше портов, чем по умолчанию.  
 `-r`: Сканировать порты последовательно (без рандомизации).  
 `--top-ports <число>`: Сканировать только самые популярные порты.  
 `--port-ratio <коэффициент>`: Сканировать порты с популярностью выше указанного коэффициента.  
##### примеры
1. **Сканирование 100 самых популярных портов на всех активных хостах в подсети**:  
```bash
nmap --top-ports 100 -sn 192.168.0.0/24
```
2. **Сканирование только TCP 80 и UDP 53 портов**:  
   ```bash
   nmap -p T:80,U:53 192.168.1.1
   ```
3. **Обход файервола с помощью Xmas-сканирования**:  
```bash
nmap -sX 192.168.1.1
```
4. **Idle-сканирование для сокрытия источника**:  
```bash
nmap -sI 192.168.1.100 192.168.1.1
```
5. **Быстрое сканирование всех хостов в подсети**:  
```bash
nmap -F 192.168.0.0/24
```

##### Обнаружение служб и версий (Service/Version Detection)
Nmap может не только находить открытые порты, но и определять, какие службы работают на этих портах, а также их версии.
```bash
nmap -sV 192.168.1.1
nmap -sV --version-intensity 5 192.168.1.1
nmap -sV --version-light 192.168.1.1
nmap -sV --version-all 192.168.1.1
nmap -sV --version-trace 192.168.1.1
```
 `-sV`: Выполняет запрос к открытым портам для определения службы и версии.  
 `--version-intensity <уровень>`: Устанавливает интенсивность анализа от 0 (минимальный) до 9 (максимальный).  
 `--version-light`: Использует только наиболее вероятные методы обнаружения (эквивалент интенсивности 2). 
 `--version-all`: Пробует все доступные методы (интенсивность 9). 
 `--version-trace`: Выводит подробную информацию о процессе обнаружения версий 

##### Сканирование с использованием скриптов (Script Scan)
Nmap имеет мощную систему скриптов (Nmap Scripting Engine, NSE), которая расширяет функциональность инструмента.
```bash
nmap -sC 192.168.1.1
nmap --script=http-title 192.168.1.1
nmap --script=vuln 192.168.1.1

nmap --script=http-brute --script-args userdb=users.txt,passdb=passwords.txt 192.168.1.1

nmap --script-args-file=args.txt 192.168.1.1

nmap --script http-title --script-trace 192.168.1.1
nmap --script-updatedb
nmap --script-help=http-title
```
 `-sC`: Использует стандартный набор скриптов. Эквивалентно `--script=default`.  
 `--script=<скрипты>`: Указывает конкретные скрипты, категории или директории через запятую. 
 `--script-args=<аргументы>`: Передаёт параметры для скриптов. 
 `--script-args-file=<файл>`: Передаёт аргументы скриптов из файла.
 `--script-trace`: Показывает все данные, отправленные и полученные скриптами. 
 `--script-updatedb`: Обновляет базу данных скриптов. 
 `--script-help=<скрипты>`: Выводит справку по указанным скриптам или категориям. 

##### Определение операционной системы (OS Detection)
Nmap может анализировать параметры сетевого стека, чтобы определить используемую операционную систему цели.
```bash
nmap -O 192.168.1.1
nmap -O --osscan-limit 192.168.1.0/24
nmap -O --osscan-guess 192.168.1.1
```
`-O`: Включает определение ОС.  
`--osscan-limit`: Ограничивает определение ОС только для перспективных целей (например, с открытыми портами).  
 `--osscan-guess`: Использует более агрессивные методы для определения ОС. Полезно для случаев, когда стандартные методы не дают точного результата.  
  #####  примеры
1. **Сканирование с определением служб, версий и операционной системы**: 
   ```bash
   nmap -sV -O 192.168.1.1
   ```
2. **Сканирование с использованием стандартных скриптов и интенсивного анализа версий**:  
   ```bash
   nmap -sC -sV --version-intensity 7 192.168.1.1
   ```
3. **Проверка уязвимостей с использованием скриптов категории `vuln`**:  
   ```bash
   nmap --script=vuln 192.168.1.1
   ```
4. **Отладка процесса сканирования с выводом всех данных**:  
   ```bash
   nmap -sC --script-trace --version-trace 192.168.1.1
   ```
5. **Определение ОС только для хостов с открытыми портами**:  
   ```bash
   nmap -O --osscan-limit 192.168.1.0/24
   ```

##### Timing and Performance
Эти опции помогают оптимизировать скорость сканирования или адаптировать её под медленные сети.
###### Шаблоны времени:
  **Пример**:  
```bash
nmap -T4 192.168.1.1
```
 `-T<0-5>`: Устанавливает предопределённый шаблон времени. Чем выше значение, тем быстрее сканирование (но выше нагрузка на сеть).  
 `T0`: Самый медленный (подходит для скрытного сканирования).  
 `T4`: Быстрое сканирование (рекомендуется для стабильных сетей).  
 `T5`: Максимальная скорость (может вызывать ложные срабатывания IDS/IPS).
###### Группировка хостов:
```bash
nmap --min-hostgroup 10 --max-hostgroup 50 192.168.0.0/24
```
 `--min-hostgroup/max-hostgroup <размер>`: Устанавливает количество хостов для параллельного сканирования.  
###### Параллельное выполнение:
```bash
nmap --min-parallelism 5 --max-parallelism 50 192.168.1.1
```
 `--min-parallelism/max-parallelism <количество>`: Указывает количество одновременных запросов.  
###### Время ожидания (RTT):
```bash
nmap --max-rtt-timeout 500ms 192.168.1.1
```
 `--min-rtt-timeout/max-rtt-timeout/initial-rtt-timeout <время>`: Указывает минимальное, максимальное и начальное время ожидания отклика.  
###### Ограничение повторных запросов:
```bash
nmap --max-retries 3 192.168.1.1
```
 `--max-retries <число>`: Задаёт максимальное количество повторов запроса к порту.  
###### Лимит времени для хоста:
```bash
nmap --host-timeout 5m 192.168.1.1
```
 `--host-timeout <время>`: Прекращает сканирование хоста, если он не отвечает за указанное время.  
##### Скорость отправки пакетов:
```bash
nmap --min-rate 100 --max-rate 500 192.168.1.1
```
 `--min-rate <число>`: Указывает минимальную скорость отправки пакетов (в секунду).  
 `--max-rate <число>`: Устанавливает максимальную скорость отправки пакетов.  

##### Firewall/IDS Evasion and Spoofing
Эти опции позволяют скрывать активность и обходить сетевые защитные механизмы.
###### Фрагментация пакетов:
```bash
nmap -f 192.168.1.1
nmap --mtu 16 192.168.1.1
```
 `-f`: Фрагментирует пакеты для обхода фильтров.  
 `--mtu <размер>`: Указывает размер MTU для фрагментации.  
###### Маскировка источника:
  **Пример**:  
```bash
nmap -D 192.168.1.100,192.168.1.101,ME 192.168.1.1
```
 `-D <приманки>`: Добавляет приманки (decoys), чтобы скрыть реальный источник сканирования.  

```bash
nmap -S 203.0.113.10 192.168.1.1
nmap -e eth0 192.168.1.1
nmap -g 53 192.168.1.1
```
`-S <IP-адрес>`: Подмена IP-адреса источника (нужны права root).  
`-e <интерфейс>`: Указывает сетевой интерфейс. 
`-g/--source-port <порт>`: Задаёт исходный порт. Может использоваться для обхода правил файервола.  
###### Работа с данными:
```bash
nmap --data 48656c6c6f 192.168.1.1
nmap --data-string "Hello" 192.168.1.1
nmap --data-length 50 192.168.1.1
```
 `--data <hex>`: Добавляет произвольные данные в пакеты в формате HEX.  
 `--data-string <строка>`: Добавляет строку ASCII в пакеты.  
 `--data-length <длина>`: Добавляет случайные данные указанной длины.  
###### MAC- и IP-опции:
 ```bash
nmap --ttl 64 192.168.1.1
nmap --spoof-mac 00:11:22:33:44:55 192.168.1.1
nmap --spoof-mac Cisco 192.168.1.1
```
`--ip-options <опции>`: Добавляет IP-опции в пакеты.  
`--ttl <значение>`: Устанавливает поле TTL в IP-заголовке.  
`--spoof-mac <MAC>`: Подменяет MAC-адрес.  

###### Другие способы обхода:
```bash
nmap --proxies http://proxy1:8080,http://proxy2:8080 192.168.1.1
nmap --badsum 192.168.1.1
```
`--proxies <URL>`: Использует указанные HTTP/SOCKS4 прокси для сканирования.  
`--badsum`: Отправляет пакеты с ошибочной контрольной суммой для тестирования систем.  
##### примеры
1. **Быстрое сканирование с фрагментацией пакетов и приманками**:  
```bash
nmap -f -D 192.168.1.100,192.168.1.101 192.168.1.1
```
2. **Сканирование с подменой MAC-адреса и низким TTL**:  
```bash
nmap --spoof-mac Cisco --ttl 10 192.168.1.1
```
3. **Сканирование с минимальной скоростью отправки пакетов**:  
```bash
nmap --min-rate 10 192.168.1.1
```
4. **Использование определённого исходного порта для обхода файервола**:  
```bash
nmap -g 80 192.168.1.1
```
5. **Агрессивное сканирование с таймаутом на хост**:  
```bash
nmap -T5 --host-timeout 2m 192.168.1.1
```
##### Вывод результатов (Output)
###### Форматы вывода:
```bash
nmap -oN output.txt 192.168.1.1
nmap -oX output.xml 192.168.1.1
nmap -oS output.s3r 192.168.1.1
nmap -oG output.gnmap 192.168.1.1
nmap -oA output_base 192.168.1.1
```
`-oN <файл>`: Нормальный текстовый вывод в указанный файл.  
`-oX <файл>`: Вывод в формате XML для дальнейшего использования или обработки.  
`-oS <файл>`: Вывод в формате s|<rIpt kIddi3 для использования в скриптах.  
`-oG <файл>`: Вывод в формате Grepable (подходит для последующего поиска с помощью grep).  
`-oA <базовое имя>`: Выводит результат сразу в три основные формата (нормальный, XML, grepable).  
  
###### Уровень детализации:
**Пример**:  
```bash
nmap -v 192.168.1.1
nmap -d 192.168.1.1
nmap --reason 192.168.1.1
nmap --open 192.168.1.1
nmap --packet-trace 192.168.1.1
nmap --iflist
nmap --append-output -oN output.txt 192.168.1.1
nmap --resume scan_in_progress.txt
nmap --noninteractive 192.168.1.1
nmap --stylesheet http://example.com/nmap.xsl -oX output.xml 192.168.1.1
nmap --webxml -oX output.xml 192.168.1.1
nmap --no-stylesheet -oX output.xml 192.168.1.1
```
`-v`: Увеличивает уровень вывода информации (verbosity). Можно использовать несколько `-v` для большего уровня детализации.  
`-d`: Увеличивает уровень отладки. Чем больше `-d`, тем более подробный вывод.  
`--reason`: Показывает причину, почему порт находится в том или ином состоянии.  
`--open`: Показывает только открытые (или возможно открытые) порты.  
`--packet-trace`: Показывает все пакеты, отправленные и полученные во время сканирования.  
`--iflist`: Показывает интерфейсы хоста и маршруты для отладки.  
`--append-output`: Добавляет данные в файл вывода, а не перезаписывает его.  
`--resume <файл>`: Возобновляет прерванное сканирование, используя данные из указанного файла.  
`--noninteractive`: Отключает взаимодействие с пользователем во время выполнения (полезно для автоматизации).  
`--stylesheet <путь/URL>`: Указывает XSL-стили для преобразования XML-вывода в HTML.
`--webxml`: Использует встроенную XSL-стилизацию от Nmap для преобразования XML-вывода в HTML.  
`--no-stylesheet`: Отключает привязку XSL-стилизации к XML-выходу.  

## Разные параметры (Misc)
```bash
nmap -6 ipv6.google.com

nmap -A 192.168.1.1
nmap --datadir /path/to/nmap/data 192.168.1.1
nmap --send-eth 192.168.1.1
nmap --privileged 192.168.1.1
nmap --unprivileged 192.168.1.1

nmap -V
nmap -h
```
`-6`: Включает сканирование по IPv6.  
`-A`: Включает детекцию ОС, версий, сканирование скриптов и трассировку маршрута.  
`--datadir <каталог>`: Указывает каталог для пользовательских файлов данных Nmap.  
`--send-eth/--send-ip`: Отправка пакетов с использованием сырых Ethernet-кадров или IP-пакетов.  
`--privileged`: Предполагает, что пользователь обладает полными привилегиями.  
`--unprivileged`: Предполагает отсутствие привилегий для работы с сырыми сокетами.  
`-V`: Выводит номер версии Nmap.  
`-h`: Печатает справочную страницу с информацией о параметрах.  


1. **Базовое сканирование с детекцией ОС и версий**:  
 ```bash
 nmap -v -A scanme.nmap.org
 ```
2. **Ping-сканирование для диапазонов подсетей**:  
```bash
nmap -v -sn 192.168.0.0/16 10.0.0.0/8
```
3. **Рандомизированное сканирование на порту 80 для 10,000 хостов без обнаружения хостов**:  
```bash
nmap -v -iR 10000 -Pn -p 80
```


------------

### bash ctf recon script

Предоставленный Bash-скрипт использует инструмент **nmap**, который является мощным средством для сканирования сетей и часто используется для исследования сети и аудита безопасности. Ниже приведено подробное объяснение каждой части скрипта.

```bash
#!/bin/bash
ports=$(nmap -p- --min-rate=500 $1 | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//)
nmap -p$ports -A $1
```

`#!/bin/bash`: Эта строка указывает, что скрипт должен выполняться в оболочке Bash.

`nmap -p- --min-rate=500 $1`
`-p-`: Эта опция указывает Nmap сканировать все порты (от 1 до 65535).
`--min-rate=500`: Устанавливает минимальную скорость отправки пакетов в секунду на уровне 500, что ускоряет сканирование.
`$1`: Это позиционный параметр, представляющий первый аргумент, переданный скрипту, обычно IP-адрес или имя хоста.
  
`grep ^[0-9]`: Фильтрует строки, которые начинаются с числа, что соответствует открытым портам.

`cut -d '/' -f 1`: Извлекает только номера портов из вывода, игнорируя любую дополнительную информацию, такую как названия служб или состояния.

`tr '\n' ','`: Преобразует символы новой строки в запятые, создавая список портов, разделённых запятыми.

`sed s/,$//`: Удаляет завершающую запятую из списка.

##### Агрессивное Сканирование
`nmap -p$ports -A $1`: Эта команда выполняет ещё одно сканирование Nmap с использованием списка портов, полученного из предыдущей команды.
`-p$ports`: Указывает порты для сканирования, где `$ports` — это созданный ранее список портов, разделённых запятыми.
`-A`: Включает агрессивные параметры сканирования, которые включают определение ОС, определение версии, сканирование сценариев и возможности трассировки.

Этот скрипт эффективно автоматизирует двухэтапный процесс сканирования сети:
1. Сначала он определяет все открытые порты на указанной цели (переданной в качестве аргумента при запуске скрипта).
2. Затем он выполняет детальное сканирование этих определённых портов для сбора дополнительной информации о службах, работающих на них, и их операционных системах.

Чтобы запустить этот скрипт, вы должны сохранить его как файл с расширением `.sh` и выполнить его из командной строки следующим образом:
```bash
./script.sh <target_ip_or_hostname>
```
Где `<target_ip_or_hostname>` заменяется на фактический IP-адрес или имя хоста, который вы хотите просканировать.

Этот скрипт полезен для сетевых администраторов и специалистов по безопасности, которым необходимо быстро оценить безопасность сети путем идентификации открытых портов и служб, работающих на них.

----------

>video review 1h. +
https://www.youtube.com/watch?v=JHAMj2vN2oU


>stealth scan
https://www.youtube.com/watch?v=V3PZ0jelvak